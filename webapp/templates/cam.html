<!DOCTYPE html>
<html>
<head>
<title>AM.I.VERYMAD.NET</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<style type="text/css">

html, body {
  margin: 0px;
  padding: 0px;
  background: black;
  overflow: hidden;
}

#result {
  position:  absolute;
  top: 10px;
  left: 10px;
  margin:  20px;
  padding:  20px;
  color: white;
  background: rgba(0,0,0,0.3);
  font-size: 20px;
  font-family: sans-serif;
}

</style>


<script>

window.onload = function() {

  video = document.querySelector("#video");

  blobs_recorded = [];

//   camera_button.onclick = start.bind(this, video);

//   // addEventListener('click', async start;

  start(video);

};

async function start(video) {
  try {
    
    camera_stream = await navigator.mediaDevices.getUserMedia(
      { video: true, audio: false } );

    video.srcObject = camera_stream;

    record();

    document.getElementById('result').innerText = 'Capturing webcam..';

  } catch(error) {
    alert(error.message);
    return;
  }



};

function record() {


  media_recorder = new MediaRecorder(camera_stream, { mimeType: 'video/webm' });

      media_recorder.addEventListener('dataavailable', function(e) {
        // blobs_recorded.push(e.data);

        video_local = new Blob([e.data], { type: 'video/webm' });


         xhr = new XMLHttpRequest();
         xhr.responseType = 'json';
         xhr.open("POST", '/stress', true);
         //creating form data to append files
         var fd = new FormData();
         //append the recorded blob
         fd.append("file",video_local);
       //send data to server..............

        xhr.onreadystatechange = (e) => { // Call a function when the state changes.
          if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            // Request finished. Do processing here.
            
            res = xhr.response.StressScore;

            scores = '';

            for (var i in res) {
              scores += res[i].toFixed(3)+'<br>';
            }

            document.getElementById('result').innerHTML = scores;

          }
        }


        document.getElementById('result').innerText = 'Predicting..';


         xhr.send(fd);


      });

      media_recorder.start();

      setTimeout(stop, 7000);

      // stop();
      // start_button.style.display = 'none';

};

function stop() {

  media_recorder.stop(); 

};

</script>



</head>

<body>

<video id="video" style="width:100%;height:100" autoplay></video>
<div id="result"></div>

</body>
</html>